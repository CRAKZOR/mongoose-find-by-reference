"use strict";function e(e,r){if(r==null||r>e.length)r=e.length;for(var t=0,n=new Array(r);t<r;t++)n[t]=e[t];return n}function r(e){if(Array.isArray(e))return e}function t(r){if(Array.isArray(r))return e(r)}function n(e,r,t,n,o,i,a){try{var u=e[i](a);var c=u.value}catch(e){t(e);return}if(u.done){r(c)}else{Promise.resolve(c).then(n,o)}}function o(e){return function(){var r=this,t=arguments;return new Promise(function(o,i){var a=e.apply(r,t);function u(e){n(a,o,i,u,c,"next",e)}function c(e){n(a,o,i,u,c,"throw",e)}u(undefined)})}}function i(e,r,t){if(r in e){Object.defineProperty(e,r,{value:t,enumerable:true,configurable:true,writable:true})}else{e[r]=t}return e}function a(e){if(typeof Symbol!=="undefined"&&e[Symbol.iterator]!=null||e["@@iterator"]!=null)return Array.from(e)}function u(e,r){var t=e==null?null:typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(t==null)return;var n=[];var o=true;var i=false;var a,u;try{for(t=t.call(e);!(o=(a=t.next()).done);o=true){n.push(a.value);if(r&&n.length===r)break}}catch(e){i=true;u=e}finally{try{if(!o&&t["return"]!=null)t["return"]()}finally{if(i)throw u}}return n}function c(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function l(){throw new TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function s(e){for(var r=1;r<arguments.length;r++){var t=arguments[r]!=null?arguments[r]:{};var n=Object.keys(t);if(typeof Object.getOwnPropertySymbols==="function"){n=n.concat(Object.getOwnPropertySymbols(t).filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))}n.forEach(function(r){i(e,r,t[r])})}return e}function f(e,t){return r(e)||u(e,t)||p(e,t)||c()}function y(e){return t(e)||a(e)||p(e)||l()}function h(e){"@swc/helpers - typeof";return e&&typeof Symbol!=="undefined"&&e.constructor===Symbol?"symbol":typeof e}function p(r,t){if(!r)return;if(typeof r==="string")return e(r,t);var n=Object.prototype.toString.call(r).slice(8,-1);if(n==="Object"&&r.constructor)n=r.constructor.name;if(n==="Map"||n==="Set")return Array.from(n);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return e(r,t)}function b(e,r){var t,n,o,i,a={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]};return i={next:u(0),"throw":u(1),"return":u(2)},typeof Symbol==="function"&&(i[Symbol.iterator]=function(){return this}),i;function u(e){return function(r){return c([e,r])}}function c(i){if(t)throw new TypeError("Generator is already executing.");while(a)try{if(t=1,n&&(o=i[0]&2?n["return"]:i[0]?n["throw"]||((o=n["return"])&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;if(n=0,o)i=[i[0]&2,o.value];switch(i[0]){case 0:case 1:o=i;break;case 4:a.label++;return{value:i[1],done:false};case 5:a.label++;n=i[1];i=[0];continue;case 7:i=a.ops.pop();a.trys.pop();continue;default:if(!(o=a.trys,o=o.length>0&&o[o.length-1])&&(i[0]===6||i[0]===2)){a=0;continue}if(i[0]===3&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(i[0]===6&&a.label<o[1]){a.label=o[1];o=i;break}if(o&&a.label<o[2]){a.label=o[2];a.ops.push(i);break}if(o[2])a.ops.pop();a.trys.pop();continue}i=r.call(e,a)}catch(e){i=[6,e];n=0}finally{t=o=0}if(i[0]&5)throw i[1];return{value:i[0]?i[1]:void 0,done:true}}}function v(e){var r=typeof Symbol==="function"&&Symbol.iterator,t=r&&e[r],n=0;if(t)return t.call(e);if(e&&typeof e.length==="number")return{next:function(){if(e&&n>=e.length)e=void 0;return{value:e&&e[n++],done:!e}}};throw new TypeError(r?"Object is not iterable.":"Symbol.iterator is not defined.")}var d=Object.defineProperty;var m=Object.getOwnPropertyDescriptor;var j=Object.getOwnPropertyNames;var w=Object.prototype.hasOwnProperty;var O=function(e,r){for(var t in r)d(e,t,{get:r[t],enumerable:!0})},g=function(e,r,t,n){var o=true,i=false,a=undefined;if(r&&typeof r=="object"||typeof r=="function")try{var u=function(){var o=l.value;!w.call(e,o)&&o!==t&&d(e,o,{get:function(){return r[o]},enumerable:!(n=m(r,o))||n.enumerable})};for(var c=j(r)[Symbol.iterator](),l;!(o=(l=c.next()).done);o=true)u()}catch(e){i=true;a=e}finally{try{if(!o&&c.return!=null){c.return()}}finally{if(i){throw a}}}return e};var S=function(e){return g(d({},"__esModule",{value:!0}),e)};var x={};O(x,{MongooseFindByReference:function(){return k}});module.exports=S(x);var A=require("mongoose"),E={schemaTypeError:{"zh-CN":'参数 "schema" 的类型得是 "Schema"。',"en-US":'param "schema" type must be "Schema".'},modelCountError:{"zh-CN":"钩子函数访问到的 Model 数量为 0 或者不存在。","en-US":"The number of models accessed is 0 or does not exist."}};function P(e){if(e in E){var r=E[e];var t;return((t=process.env.LANG)!==null&&t!==void 0?t:"").match("CN")?r["zh-CN"]:r["en-US"]}}function k(e){if(e.constructor.name!=="Schema")throw new Error(P("schemaTypeError"));e.pre(["find","findOne","distinct"],function(){var e=o(function(e){var r,t,n;function a(e){var t,n;var o="";if(((t=e)===null||t===void 0?void 0:t.instance)==="ObjectID"){var i,u;var c=e.options;((u=c)===null||u===void 0?void 0:(i=u.ref)===null||i===void 0?void 0:i.length)&&(o=c.ref)}else if((n=e)===null||n===void 0?void 0:n.$embeddedSchemaType)return a(e.$embeddedSchemaType);return r[o]}function u(e){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:t;var n=[];for(;e.length>0;){var o;var i=(o=e.shift())!==null&&o!==void 0?o:"";if(r.path(y(n).concat([i]).join(".")))n.push(i);else{var c=a(r.path(n.join(".")));if(c){var l;var s=u([i].concat(y(e)),c.schema);if(e.length)(l=n).push.apply(l,y(s));else return[n.join(".")].concat(y(s))}else return y(n).concat([i])}}return n}function c(e){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:".",t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"";var n={};var o=true,i=false,a=undefined;try{for(var u=Object.entries(e)[Symbol.iterator](),l;!(o=(l=u.next()).done);o=true){var y=f(l.value,2),h=y[0],p=y[1];var b=t?"".concat(t).concat(r).concat(h):h;if(p.constructor===Object&&!Object.keys(p).some(function(e){return e.startsWith("$")})){var v=c(p,r,b);n=s({},n,v)}else n[b]=p}}catch(e){i=true;a=e}finally{try{if(!o&&u.return!=null){u.return()}}finally{if(i){throw a}}}return n}function l(e,r){return p.apply(this,arguments)}function p(){p=o(function(e,r){var n,s,p,d,m,j,w,O,g,S,x;var E=arguments;return b(this,function(P){switch(P.label){case 0:n=E.length>2&&E[2]!==void 0?E[2]:t;if(typeof r!="object"||r===null||Object.keys(r).length===0)return[2,r];s={},p=n.path(e.join("."));d=true,m=false,j=undefined;P.label=1;case 1:P.trys.push([1,6,7,8]);w=function(){var r,h,v,d,m,j,w,O,S,x,E,P,k,T,$,C,I,M,N,_,R,U;return b(this,function(z){switch(z.label){case 0:r=f(g.value,2),h=r[0],v=r[1];if(!t.path(h)){d=y(u(h.split("."))).concat([v]).reduceRight(function(e,r){return r==="$"?e:i({},r,e)});m=f(Object.entries(d),1),j=f(m[0],2),h=j[0],v=j[1],j,m}w=h.startsWith("$")?h==="$"?e:[]:y(e).concat([h]),O=w.join("."),S=n.path(O);if(!(!h.startsWith("$")&&S===void 0))return[3,3];x=a(p);if(!x)return[3,3];return[4,l([],v,x.schema)];case 1:E=z.sent();if(!E)return[3,3];P={};k={};return[4,x.find(c(i({},h,E)),"_id")];case 2:return[2,(P.v=(k.$in=z.sent().map(function(e){return e._id}),k),P)];case 3:if(!Array.isArray(v))return[3,5];$=Object.assign;C=[s];I=[{},h];return[4,Promise.all(v.map(function(){var e=o(function(e){return b(this,function(r){switch(r.label){case 0:return[4,l(w,e,n)];case 1:return[2,r.sent()]}})});return function(r){return e.apply(this,arguments)}}()))];case 4:T=$.apply(Object,C.concat([i.apply(void 0,I.concat([z.sent()]))]));return[3,9];case 5:if(!(typeof v=="object"&&v!==null&&Object.keys(v).length>0&&!(0,A.isValidObjectId)(v)))return[3,7];N=Object.assign;_=[s];R=[{},h];U=Object.fromEntries;return[4,Promise.all(Object.entries(v).map(function(){var e=o(function(e){var r,t,o,a;return b(this,function(u){switch(u.label){case 0:r=f(e,2),t=r[0],o=r[1];a=Object.entries;return[4,l(w,i({},t,o),n)];case 1:return[2,a.apply(Object,[u.sent()])[0]]}})});return function(r){return e.apply(this,arguments)}}()))];case 6:M=N.apply(Object,_.concat([i.apply(void 0,R.concat([U.apply(Object,[z.sent()])]))]));return[3,8];case 7:M=s[h]=v;z.label=8;case 8:T=M;z.label=9;case 9:T;return[2]}})};O=Object.entries(r)[Symbol.iterator]();P.label=2;case 2:if(!!(d=(g=O.next()).done))return[3,5];return[5,v(w())];case 3:S=P.sent();if(h(S)==="object")return[2,S.v];P.label=4;case 4:d=true;return[3,2];case 5:return[3,8];case 6:x=P.sent();m=true;j=x;return[3,8];case 7:try{if(!d&&O.return!=null){O.return()}}finally{if(m){throw j}}return[7];case 8:return[2,s]}})});return p.apply(this,arguments)}return b(this,function(o){switch(o.label){case 0:r=this.model.db.models;if(Object.keys(r!==null&&r!==void 0?r:{}).length===0)throw new Error(P("modelCountError"));t=this.model.schema;n=this;return[4,l([],this._conditions)];case 1:n._conditions=o.sent(),e();return[2]}})});return function(r){return e.apply(this,arguments)}}())}0&&(module.exports={MongooseFindByReference:MongooseFindByReference});//# sourceMappingURL=main.js.map